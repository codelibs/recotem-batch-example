name: backend
type: Scheduled Job
on:
  schedule: "@daily"
image:
  build: Dockerfile
  healthcheck:
    command: ["CMD-SHELL", "curl -f http://localhost:80/api/ping/ || exit 1"]
    interval: 10s
    retries: 5
    timeout: 5s
    start_period: 5s
cpu: 1024
memory: 4096
variables:
  CELERY_BROKER_URL: "amqp://user:bitnami@localhost:5672"
  DATABASE_URL: "postgresql://recotem_user:VeryBadPassword@localhost:5432/recotem"
  RECOTEM_URL: "http://localhost:80"
  RECOTEM_USERNAME: admin
  RECOTEM_PASSWORD: very_bad_password
  USER_COLUMN: userId
  ITEM_COLUMN: itemId
  TIME_COLUMN: timestamp
  HELDOUT_RATIO: 0.3
  TEST_USER_RATIO: 1.0
  CUTOFF: 10
  TARGET_METRIC: map
  N_TASKS_PARALLEL: 1
  MEMORY_BUDGET: 1000
  N_TRIALS: 5
  MODEL_PATH: /opt/app/model/model.pkl
sidecars:
  queue:
    image: bitnami/rabbitmq:3.9
  db:
    image: postgres:12
    variables:
      PGDATA: /var/lib/postgresql/data/pgdata
      POSTGRES_USER: recotem_user
      POSTGRES_PASSWORD: VeryBadPassword
      POSTGRES_DB: recotem
  celery_worker:
    image: ghcr.io/codelibs/recotem-worker:snapshot
    variables:
      CELERY_BROKER_URL: "amqp://user:bitnami@localhost:5672"
      DATABASE_URL: "postgresql://recotem_user:VeryBadPassword@localhost:5432/recotem"
    depends_on:
      backend: HEALTHY
taskdef_overrides:
  - path: ContainerDefinitions[0].mountPoints
    value:
      - sourceVolume: dataVolume
        containerPath: /app/data
        readOnly: false
  - path: ContainerDefinitions[0].dependsOn
    value:
      - containerName: db
        condition: HEALTHY
      - containerName: queue
        condition: HEALTHY
  - path: ContainerDefinitions[1].essential
    value: false
  - path: ContainerDefinitions[1].healthCheck.command
    value: ["CMD-SHELL", "rabbitmq-diagnostics -q ping"]
  - path: ContainerDefinitions[1].healthCheck.interval
    value: 10
  - path: ContainerDefinitions[1].healthCheck.retries
    value: 3
  - path: ContainerDefinitions[1].healthCheck.timeout
    value: 5
  - path: ContainerDefinitions[1].healthCheck.startPeriod
    value: 5
  - path: ContainerDefinitions[2].essential
    value: false
  - path: ContainerDefinitions[2].healthCheck.command
    value: ["CMD-SHELL", "pg_isready -U recotem_user -d recotem"]
  - path: ContainerDefinitions[2].healthCheck.interval
    value: 10
  - path: ContainerDefinitions[2].healthCheck.retries
    value: 3
  - path: ContainerDefinitions[2].healthCheck.timeout
    value: 5
  - path: ContainerDefinitions[2].healthCheck.startPeriod
    value: 5
  - path: ContainerDefinitions[3].essential
    value: false
  - path: ContainerDefinitions[3].mountPoints
    value:
      - sourceVolume: dataVolume
        containerPath: /app/data
        readOnly: false
  - path: volumes
    value:
      - name: dataVolume
